image : mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - build
  - test
  - release
  - deploy

before_script:
  - apt-get update && apt-get install -y wget
  - wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
  - chmod +x dotnet-install.sh

build:
  stage: build
  tags: 
    - net5
  script:
    - ./dotnet-install.sh -c 6.0 --install-dir /usr/share/dotnet
    - ./dotnet-install.sh -c 7.0 --install-dir /usr/share/dotnet
    - export PATH="$PATH:/usr/share/dotnet"
    - dotnet build

test:
  stage: test
  tags: 
    - net5
  script:
    - ./dotnet-install.sh -c 6.0 --install-dir /usr/share/dotnet
    - ./dotnet-install.sh -c 7.0 --install-dir /usr/share/dotnet
    - export PATH="$PATH:/usr/share/dotnet"
    - dotnet test

release:
  stage: release
  tags: 
    - net5
  only:
    - master
  artifacts:
    paths:
      - SDK/
    expire_in: 1 week
  script:
    - dotnet publish -c Release -o ../SDK -f net6.0 SDK/SDK.csproj
    - dotnet publish -c Release -o ../SDK -f net7.0 SDK/SDK.csproj
    - dotnet publish -c Release -o ../SDK -f net8.0 SDK/SDK.csproj

deploy:
  stage: deploy
  tags: 
    - net5
  artifacts:
    paths:
      - SDK/
    expire_in: 1 week
  script:
    - dotnet pack -c Release
    - dotnet nuget add source https://gitlab.twinzo.eu/api/v4/projects/189/packages/nuget/index.json -n gitlab_tDevkit -u $deploy_user -p $deploy_token --store-password-in-clear-text
    - dotnet nuget push "SDK/bin/Release/*.nupkg" --source gitlab_tDevkit
  only:
    - master

