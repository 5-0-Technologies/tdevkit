stages:
  - build
  - test
  - release
  - deploy

# .NET 9 jobs
build_net9:
  stage: build
  tags: 
    - dotnet9
  script:
    - dotnet build -p:TargetFrameworkOverride=net9.0

test_net9:
  stage: test
  tags: 
    - dotnet9
  script:
    - dotnet test -p:TargetFrameworkOverride=net9.0

release_net9:
  stage: release
  tags:
    - dotnet9
  only:
    - master
  artifacts:
    paths:
      - SDK/net9.0/*.nupkg
    expire_in: 1 week
  script:
    - mkdir -p SDK/net9.0
    - dotnet publish -c Release -p:TargetFrameworkOverride=net9.0 -f net9.0 -o SDK/net9.0 SDK/SDK.csproj
    - dotnet pack -c Release -p:TargetFrameworkOverride=net9.0 -o SDK/net9.0 SDK/SDK.csproj

# .NET 10 jobs
build_net10:
  stage: build
  tags: 
    - dotnet10
  script:
    - dotnet build -p:TargetFrameworkOverride=net10.0

test_net10:
  stage: test
  tags: 
    - dotnet10
  script:
    - dotnet test -p:TargetFrameworkOverride=net10.0

release_net10:
  stage: release
  tags:
    - dotnet10
  only:
    - master
  artifacts:
    paths:
      - SDK/net10.0/*.nupkg
    expire_in: 1 week
  script:
    - mkdir -p SDK/net10.0
    - dotnet publish -c Release -p:TargetFrameworkOverride=net10.0 -f net10.0 -o SDK/net10.0 SDK/SDK.csproj
    - dotnet pack -c Release -p:TargetFrameworkOverride=net10.0 -o SDK/net10.0 SDK/SDK.csproj
# Deploy stage to push NuGet packages using released artifacts
deploy:
  stage: deploy
  tags:
    - dotnet10
  dependencies:
    - release_net9
    - release_net10
  only:
    - master
  script:
    - dotnet nuget add source https://gitlab.twinzo.eu/api/v4/projects/189/packages/nuget/index.json -n gitlab_tDevkit -u $deploy_user -p $deploy_token --store-password-in-clear-text
    - dotnet nuget push "SDK/net9.0/*.nupkg" --source gitlab_tDevkit
    - dotnet nuget push "SDK/net10.0/*.nupkg" --source gitlab_tDevkit